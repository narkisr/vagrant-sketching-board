<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">

    <title>Vagrant sketching board</title>

    <meta name="description" content="Using Vagrant as your devops sketching board">
    <meta name="author" content="Ronen Narkis">

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <link rel="stylesheet" href="css/custom.css">
    <link rel="stylesheet" href="css/reveal.min.css">
    <link rel="stylesheet" href="css/theme/night.css" id="theme">
    <link rel="stylesheet" href="css/effects.css">

    <!-- For syntax highlighting -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- If the query includes 'print-pdf', use the PDF print sheet -->
    <script>
	document.write( '<link rel="stylesheet" href="css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );
    </script>

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script>
    <script src="js/cuepoint.js"></script>
    <!--[if lt IE 9]>
		    <script src="lib/js/html5shiv.js"></script>
		    <![endif]-->

    <script>
	$(document).ready(function(){ //Slides object with a time (integer) and a html string
	    	});
    </script>
  </head>

  <body>

    <div class="reveal">

	<!-- Any section element inside of this container is displayed as a slide -->
	<div class="slides">

	  <section>
	    <h2>Vagrant sketching board</h1>
	    <h5>Playing in the sandbox</h4>
	    <p>
		<small>Created by <a href="narkisr.com">Ronen Narkis</a> / <a href="http://twitter.com/narkisr">@narkisr</a></small>
	    </p>
	  </section>

	  <section>
	    <h2>Vagrant</h2>
	    <p>
		<ul>
		  <li>Introduction</li>
		  <li>Basic workflow</li>
		  <li>Philosophy</li>
		  <li>Some (Advanced) use cases</li>
		</ul>
	    </p>

	    <aside class="notes">
		Today will be talking on Vagrant, not just as tool but as an approach for developing your devop infra
	    </aside>
	  </section>

	 	  <section id='Vagrant basics'>
	    <section>
		<p>
		  <h2>vaÂ·grant </h2>
		  " A person without a settled home or regular work who wanders from place to place and lives by begging."
		</p>
	    </section>

          <section class='cuepoint' data-state='vagrant-demo'> 
		<video id="vagrant-vid" width="768" preload="auto" controls="" poster="">
		  <source src="Videos/vagrant-demo.ogv">
		</video>
		<div id="vagrant-sub" class='subtitles'></div>
	    </section>

	    <section>
		<h4> Vagrantfile </h4>
		<pre><code class='ruby'> 
Vagrant::Config.run do |config|

  config.vm.define :foo do |foo|
    foo.vm.box = 'ubuntu-12.10'
    foo.vm.network :bridged
    foo.vm.customize ['modifyvm', :id, '--memory', 2048, '--cpus', 4]
    foo.vm.host_name = 'foo'
  end

end 
		</code></pre>
		<aside class="notes"> 
		  No point in using Vagrant init as it creates a pile of garbage, 
		</aside>
	    </section>
        <section>
          <h4> Puppet integration </h4>               	
		<pre><code class='ruby'> 
Vagrant::Config.run do |config|

  config.vm.define :foo do |foo|
    foo.vm.box = 'ubuntu-12.10'
    foo.vm.network :bridged
    foo.vm.customize ['modifyvm', :id, '--memory', 2048, '--cpus', 4]
    foo.vm.host_name = 'foo'
    foo.vm.provision :puppet, 
       :options => ["--modulepath=/vagrant/modules:/vagrant/static-modules"]
  end

end 
		</code></pre>
          <aside class='notes'>puppet development workflow, side by side run and edit</aside>	
        </section>
 
        <section class='cuepoint' data-state='puppet-demo'> 
	     <video id="puppet-vid" width="768" preload="auto" controls="" poster="">
		  <source src="Videos/puppet-demo.ogv">
	    </video>
	    <div id="puppet-sub" class='subtitles'>Puppet integration</div>
	  </section>


	 </section>

	  <section data-state='whity' id='opskeleton'>
	    <section> 
		<img src="images/opskeleton.png" alt="" style='box-shadow: 0 0 0 0;border:0;' />
		<aside class="notes"> Our Opskeleton demo</aside>
		<h3> An opinionated bootstrap tool </h3>
	    </section>
	    <section>
	      <h3> The problem</h3>
		<ul>
		  <li>Too many broken Puppet modules out there</li>
		  <li>Not clear what goes where (no clear standard)</li>
		  <li>Hard to distribute living environments</li>
		  <li>Existing tools aren't used or used wrong</li>
		</ul>
	    </section>
	    <section>
		<h3> Key goals </h3>
		<ul>
		  <li>Dependency management</li>
		  <li>Best practices</li>
		  <li>Reproducibility and standardization </li>
		  <li>Evolutionary application</li>
		  <li>Code data segregation</li>
		  <li>Development workflow</li>
		</ul>
	    </section>

	    <section> 
	     <h3> Dependencies </h3>
	     <p>
	      <ul>
	        <li>OS version (Vagrantfile)</li>
	        <li>Ruby version </li>
		  <li>Gems (Puppet, Vagrant ..)</li>
	        <li>External Puppet modules</li>
	      </ul> 
	     </p> 
	    </section>

	    <section>
		<h3> Librarian Puppet</h3>
	      <pre><code class="ruby">
forge "http://forge.puppetlabs.com"

mod 'puppetlabs/stdlib'

mod 'puppetlabs/apt'

mod 'editfile',
   :git => 'git://github.com/mstrauss/puppet-editfile.git' 
	     	</code></pre>
	    </section>

	    <section>
	      <h3> RVM </h3>
<pre><code class="bash"> # .rvmrc
ruby_string="ruby-1.9.3"
gemset_name="foo-sandbox"

if rvm list strings | grep -q "${ruby_string}" ; then
  # Load or create the specified environment
  if [[ -d "${rvm_path:-$HOME/.rvm}/environments" \
        ...
  else
    rvm --create  "${ruby_string}@${gemset_name}"
  fi
  ( # Ensure that Bundler is installed, install it if it is not.
    if ! command -v bundle ; then
      gem install bundler
    fi

    # Bundle while redcing excess noise.
    bundle | grep -v 'Using' | grep -v 'complete' | sed '/^$/d'
  )&
  else 
   ...  </code></pre>
          <aside class="notes">
		Here we see the ruby version and the sandbox gemset (separation of dependencies between sandxboes)
	      Bundle is automatically installed and bundle install is executed in the background
	    </aside>
	    </section>

	    <section>
	      <h3> Bundler </h3>
	      <pre><code class="ruby">
# Gemfile

# opskelaton Gems
source "https://rubygems.org"

gem 'vagrant', '>=1.0.5'
gem 'puppet'
gem 'puppet-lint'
gem 'librarian-puppet'
gem 'rake'
		</code></pre>
	    </section>
	    <section>
	      <h3> Hiera </h3>
	      <pre><code class="ruby">
# hiera.yaml
:backends:
 - yaml
:logger: console
:hierarchy:
 - '%{::virtual}'
 - common
:yaml:
   :datadir: hieradata
		</code></pre>
	    </section>

	    <section> 
	     <h3>Easy execution</h3>
	     <pre><code class="bash">
# run.sh
puppet apply --modulepath=modules:static-modules \
       manifests/default.pp --hiera_config hiera.yaml  $@
	     </code></pre> 
	    </section>

	    <section>
		<h3> Module life cycle</h3>
		<ul>
		  <li> Developed modules go under static-modules</li>
		  <li> Once they get mature they get thier own repo</li>
		  <li> Imported back into modules</li>
		</ul>
	    </section>

	    <section class='cuepoint' data-state='opsk-demo'> 
		<video id="opsk-vid" width="768" preload="auto" controls="" poster="">
		  <source src="Videos/opsk.ogv">
		</video>
		<div id="opsk-sub" class='subtitles'>Opsk demo</div>
	    </section>

	  </section>

       <section>
	   <section> 
	    <h1> Sandboxing</h1>
	   </section>

	   <section>
	     <img src="images/cat-sandbox.jpg" width='50%' hight='50%'  alt="" />
	  </section>

	    <section> 
		<h4>Sandboxing benefits</h4>
		<ul>
		  <li>Portable (Cloud agnostic)</li>
		  <li>Easy to fork/distribute</li>
		  <li>Open for experimentation (speed and isolation wise)</li>
		  <li>Isolated from main system</li>
		  <li>Reproducible</li>
		  <li>Distributed workflow (like git but for VM's)</li>
		</ul>
	    </section>
	  </section>

   
	  <section id='use-cases'>
	    <section><h1> Use cases</h1></section>

	    <section>
	      <h3>puppet-base-env</h3>
		<p> Use a sandbox to manage development environment</p>
	  	 <video id="vagrant-vid" width="768" preload="auto" controls="" poster="">
		  <source src="Videos/basenv-demo.ogv">
		 </video>
		 <div id="vagrant-sub" class='subtitles'></div>
	    </section>

	    <section> 
		<h3> Storm </h3>
		<p>A clustered development enviroment</p>
            <img src="images/storm-topology.png" style='border:none;background:black;' alt="" /> 
	    </section>

	    <section>
	      <h3>Mutli VM </h3>
<pre><code class="ruby">Vagrant::Config.run do |config|

  config.vm.define :nimbus do |nimbus|
    # ...
    nimbus.vm.host_name = 'nimbus'
    nimbus.vm.network :hostonly, "192.168.1.10"
  end

  config.vm.define :super_a do |supervisor|
    # ...
    supervisor.vm.host_name = 'supervisor-a'
    supervisor.vm.network :hostonly, "192.168.1.11"
  end
 
  config.vm.define :super_b do |supervisor|
    # ...
    supervisor.vm.host_name = 'supervisor-b'
    supervisor.vm.network :hostonly, "192.168.1.12"
  end

end
		</code></pre>
	    </section>
	    <section> 
		<h2>Packaging (fpm) </h2>
	    </section>

	    <section>
	      <pre><code class="bash">
$ wget http://ftp.osuosl.org/pub/hudson/war/1.396/jenkins.war

$ fpm -s dir -t deb -n jenkins -v 1.396 --prefix /opt/jenkins jenkins.war

		</code></pre>
		<aside class="notes"> FPM is a really nice too but it relies upon the use of flags, it does not specify any DSL or structure</aside>
	    </section>

          <section>
            <h3> FPM Cookery</h3>
<pre><code class="ruby">class ZeroMQ < FPM::Cookery::Recipe
  description 'The Intelligent Transport Layer'

  name     'zeromq'
  version  '2.1.7'
  homepage 'http://www.zeromq.org'
  source   'http://download.zeromq.org/zeromq-2.1.7.tar.gz'
  sha256   '2a1416d0a3ea55ae17d43417fd9bd193412cc9101e144bc8d3bd19fe36816e0d'
  conflicts 'libzmq0', 'zeromq-bin'
  replaces  'libzmq0', 'zeromq-bin'

  def build
    configure :prefix => prefix
    make
  end

  def install
    make :install, 'DESTDIR' => destdir
  end
end
		</code></pre>
          </section>

	    <section class='cuepoint' data-state='storm-demo'>
	  	<video id="storm-vid" width="768" preload="auto" controls="" poster="">
		  <source src="Videos/storm-demo.ogv">
		</video>
		<div id="storm-sub" class='subtitles'></div>
	    </section>
	    <section>
	      <h3>Packaging and Provisioning</h3>
		<img src="images/packaging.png" style='box-shadow: 0 0 0 0;border:0;background:black;' alt="" />
	      <!-- <p>Using fpm-cookery to package rpms on one sandbox then consume them via Puppet on another sandbox (close the loop).</p> -->
	    </section>
	  </section>

	  <section> 
	    <section>
	      <h1> Extending Vagrant </h1>
	    </section> 

	    <section> 
		<h3> Middleware </h3>
	     
	    <pre><code class="ruby"> 
class Update
  def initialize(app, env)
    @app = app
  end

  def call(env)
    @app.call(env)
    update env[:vm] if env["vm"].state == :running
  end

  protected
  def update(vm)
    VagrantDns::NetworkBinder.new.bind(vm)
  end
end
	    </code></pre>	
	      
	    </section>

	  <section>
	    <h3> Registration </h3>
	    <pre><code class="ruby">
Vagrant.actions[:provision].insert_after(Vagrant::Action::VM::Provision, Update) 

Vagrant.actions[:start].insert_after(Vagrant::Action::VM::Boot, Update) 

Vagrant.actions[:destroy].insert_after(Vagrant::Action::VM::ProvisionerCleanup, Remove)  
	    </code></pre>
	  </section>
	  </section>
	</div>
    </div>


    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.min.js"></script>
    <script src="js/conf.js"></script>
    <script type="text/javascript"> 
      Reveal.addEventListener( 'vagrant-demo', function() {
	   console.log( 'starting vagrant demo' );
         var slides = {
	     2:  "interface",
	     15: "boxes and Local store",
	     59: "booting up",
	     142: "ssh'ing into the VM",
	     150: "network interfaces and shared folder", 
	     187: "halting and destroying",
	    }
	    cuepoint.pause();
	    cuepoint.init(slides,"vagrant-sub","vagrant-vid");
	    cuepoint.setTime(0);
	    cuepoint.play();
	});

      Reveal.addEventListener( 'puppet-demo', function() {
	   console.log( 'starting puppet demo' );
         var slides = {
	     2:  "Checking current status",
	     15: "Adding Puppet configuration",
	     28: "Adding a package",
	     47: "Run during reload",
	     120: "Adding from within",
	     142: "Local run"
	    }
	    cuepoint.pause();
	    cuepoint.init(slides,"puppet-sub","puppet-vid");
	    cuepoint.setTime(0);
	    cuepoint.play();
	});

	Reveal.addEventListener( 'opsk-demo', function() {
	   console.log( 'starting opsk demo' );
         var slides = {
	     8: "We start by generating a new project",
	     17: "All the files are created within a new git repo",
 	     27: "Bundler done installing gems ",
	     32: "Using librarian to install modules",
	     53: "Booting up the VM",
	     125: "Hostname is set",
	     132: "Adding a package", 
	     157: "Using run.sh from /vagrant"
	    }
	    cuepoint.pause();
	    cuepoint.init(slides,"opsk-sub","opsk-vid");
	    cuepoint.setTime(0);
	    cuepoint.play();
	});

	Reveal.addEventListener( 'storm-demo', function() {
	   console.log( 'starting storm demo' );
         var slides = {
	     2:   "cooking debs",
	     95:  "booting up",
	     142: "nimbus is up", 
	     194: "super_a is up", 
	     249: "super_b is up", 
	     252: "nimbus ui shows two supervisors"
	    }
	    cuepoint.pause();
	    cuepoint.init(slides,"storm-sub","storm-vid");
	    cuepoint.setTime(0);
	    cuepoint.play();
	});


    </script>

  </body>
</html>
